name: Update IPTV

on:
  schedule:
    # æ¯å¤©5ç‚¹ã€12ç‚¹ã€17ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰è¿è¡Œï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´13ç‚¹ã€20ç‚¹ã€æ¬¡æ—¥1ç‚¹
    - cron: '0 5,12,17 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_test:
        description: 'è·³è¿‡æµ‹é€Ÿæ­¥éª¤ï¼ˆä»…æ›´æ–°æºï¼‰'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.9'

jobs:
  update-iptv:
    name: Update IPTV Sources
    runs-on: ubuntu-latest
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶æ—¶é—´
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas
        echo "ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: Create template file if not exists
      run: |
        if [ ! -f "demo.txt" ]; then
          echo "åˆ›å»ºé»˜è®¤ demo.txt æ¨¡æ¿..."
          cat > demo.txt << EOF
        CCTV1
        CCTV2
        CCTV5
        CCTV5+
        CCTV6
        CCTV8
        æ¹–å—å«è§†
        æµ™æ±Ÿå«è§†
        æ±Ÿè‹å«è§†
        ä¸œæ–¹å«è§†
        åŒ—äº¬å«è§†
        å®‰å¾½å«è§†
        EOF
          echo "æ¨¡æ¿æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        else
          echo "demo.txt å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
        fi
        
    - name: Run IPTV update script
      env:
        SKIP_TEST: ${{ inputs.skip_test }}
      run: |
        echo "å¼€å§‹ IPTV æ›´æ–°æµç¨‹..."
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "è·³è¿‡æµ‹é€Ÿ: $SKIP_TEST"
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "iptv.py" ]; then
          echo "âŒ é”™è¯¯: iptv.py è„šæœ¬ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ‰§è¡Œæ›´æ–°è„šæœ¬
        python iptv.py
        
        # æ£€æŸ¥è„šæœ¬æ‰§è¡Œç»“æœ
        if [ $? -eq 0 ]; then
          echo "âœ… IPTV æ›´æ–°è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
        else
          echo "âŒ IPTV æ›´æ–°è„šæœ¬æ‰§è¡Œå¤±è´¥"
          exit 1
        fi
        
    - name: Verify generated files
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        files=("iptv.txt" "iptv.m3u" "iptv_data.json" "speed_report.txt" "process.log")
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            echo "âœ… $file å­˜åœ¨"
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ä¸ºç©º
            if [ -s "$file" ]; then
              echo "  æ–‡ä»¶å¤§å°: $(wc -l < "$file") è¡Œ"
            else
              echo "  âš ï¸  æ–‡ä»¶ä¸ºç©º"
            fi
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            exit 1
          fi
        done
        
    - name: Update documentation
      run: |
        echo "æ›´æ–°æ–‡æ¡£..."
        DATE=$(date '+%Y-%m-%d %H:%M:%S')
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        # è·å–æ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯
        TXT_LINES=$(wc -l < iptv.txt 2>/dev/null || echo "æœªçŸ¥")
        M3U_LINES=$(wc -l < iptv.m3u 2>/dev/null || echo "æœªçŸ¥")
        JSON_SIZE=$(wc -c < iptv_data.json 2>/dev/null || echo "æœªçŸ¥")
        
        cat << EOF > README.md
        # ğŸ“º IPTVç›´æ’­æºè‡ªåŠ¨æ›´æ–°ä»“åº“
        
        ## ğŸ“¢ å…è´£å£°æ˜
        1. æœ¬ä»“åº“ä»…ä¾›å­¦ä¹ ä½¿ç”¨ï¼Œè¯·å°Šé‡ç‰ˆæƒï¼Œè¯·å‹¿åˆ©ç”¨æ­¤ä»“åº“ä»äº‹å•†ä¸šè¡Œä¸ºåŠéæ³•ç”¨é€”!
        2. ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿç‰ˆæƒæ•°æ®ã€‚å¯¹äºè¿™äº›ç‰ˆæƒæ•°æ®ï¼Œæœ¬ä»“åº“ä¸æ‹¥æœ‰å®ƒä»¬çš„æ‰€æœ‰æƒã€‚ä¸ºäº†é¿å…ä¾µæƒï¼Œä½¿ç”¨è€…åŠ¡å¿…åœ¨ 24 å°æ—¶å†…æ¸…é™¤ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„ç‰ˆæƒæ•°æ®ã€‚
        3. ç”±äºä½¿ç”¨æœ¬ä»“åº“äº§ç”Ÿçš„åŒ…æ‹¬ç”±äºæœ¬åè®®æˆ–ç”±äºä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨æœ¬ä»“åº“è€Œå¼•èµ·çš„ä»»ä½•æ€§è´¨çš„ä»»ä½•ç›´æ¥ã€é—´æ¥ã€ç‰¹æ®Šã€å¶ç„¶æˆ–ç»“æœæ€§æŸå®³ç”±ä½¿ç”¨è€…è´Ÿè´£ã€‚
        4. ç¦æ­¢åœ¨è¿åå½“åœ°æ³•å¾‹æ³•è§„çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“ã€‚å¯¹äºä½¿ç”¨è€…åœ¨æ˜çŸ¥æˆ–ä¸çŸ¥å½“åœ°æ³•å¾‹æ³•è§„ä¸å…è®¸çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“æ‰€é€ æˆçš„ä»»ä½•è¿æ³•è¿è§„è¡Œä¸ºç”±ä½¿ç”¨è€…æ‰¿æ‹…ã€‚
        5. å¦‚æœå®˜æ–¹å¹³å°è§‰å¾—æœ¬ä»“åº“ä¸å¦¥ï¼Œå¯è”ç³»æœ¬ä»“åº“æ›´æ”¹æˆ–ç§»é™¤ã€‚
        
        ## ğŸ“Š æœ€è¿‘æ›´æ–°
        **æœ€åæ›´æ–°æ—¶é—´**: $DATE
        **é¢‘é“æ•°é‡**: $TXT_LINES ä¸ªé¢‘é“
        **æ’­æ”¾åˆ—è¡¨å¤§å°**: $M3U_LINES è¡Œ
        **æ•°æ®æ–‡ä»¶**: ${JSON_SIZE} å­—èŠ‚
        
        ## ğŸ“¥ ä¸‹è½½é“¾æ¥
        - [IPTVæ–‡æœ¬æ ¼å¼ (TXT)]($REPO_NAME/raw/main/iptv.txt) - $TXT_LINES ä¸ªé¢‘é“
        - [IPTV M3Uæ’­æ”¾åˆ—è¡¨]($REPO_NAME/raw/main/iptv.m3u) - $M3U_LINES è¡Œ
        - [IPTV JSONæ•°æ®]($REPO_NAME/raw/main/iptv_data.json) - ${JSON_SIZE} å­—èŠ‚
        - [æµ‹é€ŸæŠ¥å‘Š]($REPO_NAME/raw/main/speed_report.txt)
        
        ## ğŸ› ï¸ ä½¿ç”¨è¯´æ˜
        å°†ä¸Šè¿°é“¾æ¥æ·»åŠ åˆ°æ‚¨çš„IPTVæ’­æ”¾å™¨ä¸­ä½¿ç”¨ï¼š
        
        ### æ–‡æœ¬æ ¼å¼ (TXT)
        - é€‚ç”¨äºæ”¯æŒæ–‡æœ¬æ ¼å¼çš„æ’­æ”¾å™¨
        - æ ¼å¼ï¼šé¢‘é“åç§°,URL
        
        ### M3Uæ ¼å¼
        - é€‚ç”¨äºå¤§å¤šæ•°IPTVæ’­æ”¾å™¨
        - åŒ…å«é¢‘é“åˆ†ç»„å’Œé€Ÿåº¦ä¿¡æ¯
        
        ## âš¡ è‡ªåŠ¨æ›´æ–°
        æ­¤ä»“åº“é€šè¿‡GitHub Actionsè‡ªåŠ¨æ›´æ–°ï¼š
        - **æ›´æ–°æ—¶é—´**: æ¯å¤©UTCæ—¶é—´ 5:00, 12:00, 17:00 (åŒ—äº¬æ—¶é—´ 13:00, 20:00, æ¬¡æ—¥1:00)
        - **æ›´æ–°å†…å®¹**: è‡ªåŠ¨æŠ“å–ã€æµ‹é€Ÿã€ç­›é€‰æœ€ä¼˜ç›´æ’­æº
        - **è´¨é‡ä¿è¯**: åªä¿ç•™é€Ÿåº¦ > 500KB/s çš„ä¼˜è´¨æº
        
        ## ğŸ“ æ–‡ä»¶è¯´æ˜
        - \`iptv.txt\` - æ–‡æœ¬æ ¼å¼ç›´æ’­æºï¼ŒæŒ‰é¢‘é“åˆ†ç±» ($TXT_LINES ä¸ªé¢‘é“)
        - \`iptv.m3u\` - M3Uæ’­æ”¾åˆ—è¡¨æ ¼å¼ ($M3U_LINES è¡Œ)
        - \`iptv_data.json\` - å®Œæ•´çš„é¢‘é“æ•°æ®ï¼ˆJSONæ ¼å¼, ${JSON_SIZE} å­—èŠ‚ï¼‰
        - \`speed_report.txt\` - è¯¦ç»†çš„æµ‹é€ŸæŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯
        - \`process.log\` - å¤„ç†æ—¥å¿—
        - \`demo.txt\` - é¢‘é“æ¨¡æ¿æ–‡ä»¶
        
        ## ğŸ”§ æœ¬åœ°è¿è¡Œ
        å¦‚éœ€æœ¬åœ°è¿è¡Œæ›´æ–°è„šæœ¬ï¼š
        \`\`\`bash
        git clone https://github.com/$REPO_OWNER/$REPO_NAME.git
        cd $REPO_NAME
        pip install requests pandas
        python iptv.py
        \`\`\`
        
        ## â­ æ”¯æŒ
        å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStarï¼è¿™æ˜¯å¯¹æˆ‘ä»¬æœ€å¤§çš„é¼“åŠ±ï¼
        
        ---
        *è‡ªåŠ¨æ›´æ–°äº: $DATE*
        EOF
        
        echo "ğŸ“ README.md æ–‡æ¡£å·²æ›´æ–°"
        
    - name: Check for changes
      id:  check_changes
         run |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        git add -A
                pip install requests pandas
        
    - name: Create template file if not exists
      run: |
        if [ ! -f "demo.txt" ]; then
          echo "Creating default demo.txt template..."
          cat > demo.txt << EOF
        CCTV1
        CCTV2
        CCTV5
        CCTV5+
        CCTV6
        CCTV8
        æ¹–å—å«è§†
        æµ™æ±Ÿå«è§†
        æ±Ÿè‹å«è§†
        ä¸œæ–¹å«è§†
        åŒ—äº¬å«è§†
        å®‰å¾½å«è§†
        EOF
        fi
        
    - name: Run IPTV update script
      env:
        SKIP_TEST: ${{ inputs.skip_test }}
      run: |
        echo "Starting IPTV update process..."
        echo "Current time: $(date)"
        python iptv.py
        
    - name: Update documentation
      run: |
        DATE=$(date '+%Y-%m-%d %H:%M:%S')
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        cat << EOF > README.md
        # ğŸ“º IPTVç›´æ’­æºè‡ªåŠ¨æ›´æ–°ä»“åº“
        
        ## ğŸ“¢ å…è´£å£°æ˜
        1. æœ¬ä»“åº“ä»…ä¾›å­¦ä¹ ä½¿ç”¨ï¼Œè¯·å°Šé‡ç‰ˆæƒï¼Œè¯·å‹¿åˆ©ç”¨æ­¤ä»“åº“ä»äº‹å•†ä¸šè¡Œä¸ºåŠéæ³•ç”¨é€”!
        2. ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿç‰ˆæƒæ•°æ®ã€‚å¯¹äºè¿™äº›ç‰ˆæƒæ•°æ®ï¼Œæœ¬ä»“åº“ä¸æ‹¥æœ‰å®ƒä»¬çš„æ‰€æœ‰æƒã€‚ä¸ºäº†é¿å…ä¾µæƒï¼Œä½¿ç”¨è€…åŠ¡å¿…åœ¨ 24 å°æ—¶å†…æ¸…é™¤ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„ç‰ˆæƒæ•°æ®ã€‚
        3. ç”±äºä½¿ç”¨æœ¬ä»“åº“äº§ç”Ÿçš„åŒ…æ‹¬ç”±äºæœ¬åè®®æˆ–ç”±äºä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨æœ¬ä»“åº“è€Œå¼•èµ·çš„ä»»ä½•æ€§è´¨çš„ä»»ä½•ç›´æ¥ã€é—´æ¥ã€ç‰¹æ®Šã€å¶ç„¶æˆ–ç»“æœæ€§æŸå®³ç”±ä½¿ç”¨è€…è´Ÿè´£ã€‚
        4. ç¦æ­¢åœ¨è¿åå½“åœ°æ³•å¾‹æ³•è§„çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“ã€‚å¯¹äºä½¿ç”¨è€…åœ¨æ˜çŸ¥æˆ–ä¸çŸ¥å½“åœ°æ³•å¾‹æ³•è§„ä¸å…è®¸çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“æ‰€é€ æˆçš„ä»»ä½•è¿æ³•è¿è§„è¡Œä¸ºç”±ä½¿ç”¨è€…æ‰¿æ‹…ã€‚
        5. å¦‚æœå®˜æ–¹å¹³å°è§‰å¾—æœ¬ä»“åº“ä¸å¦¥ï¼Œå¯è”ç³»æœ¬ä»“åº“æ›´æ”¹æˆ–ç§»é™¤ã€‚
        
        ## ğŸ“Š æœ€è¿‘æ›´æ–°
        **æœ€åæ›´æ–°æ—¶é—´**: $DATE
        
        ## ğŸ“¥ ä¸‹è½½é“¾æ¥
        - [IPTVæ–‡æœ¬æ ¼å¼ (TXT)](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv.txt)
        - [IPTV M3Uæ’­æ”¾åˆ—è¡¨](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv.m3u)
        - [IPTV JSONæ•°æ®](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv_data.json)
        - [æµ‹é€ŸæŠ¥å‘Š](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/speed_report.txt)
        
        ## ğŸ› ï¸ ä½¿ç”¨è¯´æ˜
        å°†ä¸Šè¿°é“¾æ¥æ·»åŠ åˆ°æ‚¨çš„IPTVæ’­æ”¾å™¨ä¸­ä½¿ç”¨ï¼š
        
        ### æ–‡æœ¬æ ¼å¼ (TXT)
        - é€‚ç”¨äºæ”¯æŒæ–‡æœ¬æ ¼å¼çš„æ’­æ”¾å™¨
        - æ ¼å¼ï¼šé¢‘é“åç§°,URL
        
        ### M3Uæ ¼å¼
        - é€‚ç”¨äºå¤§å¤šæ•°IPTVæ’­æ”¾å™¨
        - åŒ…å«é¢‘é“åˆ†ç»„å’Œé€Ÿåº¦ä¿¡æ¯
        
        ### ç›´æ¥æ’­æ”¾é“¾æ¥
        æ‚¨ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ä»¥ä¸‹æ ¼å¼çš„é“¾æ¥ï¼š
        \`\`\`
        https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv.m3u
        \`\`\`
        
        ## âš¡ è‡ªåŠ¨æ›´æ–°
        æ­¤ä»“åº“é€šè¿‡GitHub Actionsè‡ªåŠ¨æ›´æ–°ï¼š
        - **æ›´æ–°æ—¶é—´**: æ¯å¤©UTCæ—¶é—´ 5:00, 12:00, 17:00 (åŒ—äº¬æ—¶é—´ 13:00, 20:00, æ¬¡æ—¥1:00)
        - **æ›´æ–°å†…å®¹**: è‡ªåŠ¨æŠ“å–ã€æµ‹é€Ÿã€ç­›é€‰æœ€ä¼˜ç›´æ’­æº
        - **è´¨é‡ä¿è¯**: åªä¿ç•™é€Ÿåº¦ > 500KB/s çš„ä¼˜è´¨æº
        
        ## ğŸ“ æ–‡ä»¶è¯´æ˜
        - \`iptv.txt\` - æ–‡æœ¬æ ¼å¼ç›´æ’­æºï¼ŒæŒ‰é¢‘é“åˆ†ç±»
        - \`iptv.m3u\` - M3Uæ’­æ”¾åˆ—è¡¨æ ¼å¼
        - \`iptv_data.json\` - å®Œæ•´çš„é¢‘é“æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
        - \`speed_report.txt\` - è¯¦ç»†çš„æµ‹é€ŸæŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯
        - \`process.log\` - å¤„ç†æ—¥å¿—
        - \`demo.txt\` - é¢‘é“æ¨¡æ¿æ–‡ä»¶
        
        ## ğŸ”§ æœ¬åœ°è¿è¡Œ
        å¦‚éœ€æœ¬åœ°è¿è¡Œæ›´æ–°è„šæœ¬ï¼š
        \`\`\`bash
        git clone https://github.com/$REPO_OWNER/$REPO_NAME.git
        cd $REPO_NAME
        pip install requests pandas
        python iptv.py
        \`\`\`
        
        ## â­ æ”¯æŒ
        å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStarï¼è¿™æ˜¯å¯¹æˆ‘ä»¬æœ€å¤§çš„é¼“åŠ±ï¼
        
        ---
        *è‡ªåŠ¨æ›´æ–°äº: $DATE*
        EOF
        
        echo "ğŸ“ README.md æ–‡æ¡£å·²æ›´æ–°"
        
    - name: Check for changes
      id: check_changes
      run: |
        echo "Checking for file changes..."
        git add -A
        if git diff --staged --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in the following files:"
          git diff --staged --name-only
        fi
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        echo "Committing and pushing changes..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "ğŸ”„ Auto-update IPTV sources and documentation - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
        
    - name: Upload generated files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: iptv-sources
        path: |
          iptv.txt
          iptv.m3u
          iptv_data.json
          speed_report.txt
          process.log
          README.md
        retention-days: 7
        
    - name: Notify success
      if: success()
      run: |
        echo "ğŸ‰ IPTV update completed successfully!"
        echo "ğŸ“Š Generated files:"
        echo "  - iptv.txt"
        echo "  - iptv.m3u" 
        echo "  - iptv_data.json"
        echo "  - speed_report.txt"
        echo "  - process.log"
        echo "  - README.md"
        
    - name: Notify failure
      if: failure()
      run: |
        echo "âŒ IPTV update failed!"
        echo "Please check the workflow logs for details."
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iptv-sources
        path: |
          iptv.txt
          iptv.m3u
        retention-days: 7
