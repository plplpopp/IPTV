name: Update IPTV

on:
  schedule:
    # ÊØèÂ§©5ÁÇπ„ÄÅ12ÁÇπ„ÄÅ17ÁÇπÔºàUTCÊó∂Èó¥ÔºâËøêË°åÔºåÂØπÂ∫îÂåó‰∫¨Êó∂Èó¥13ÁÇπ„ÄÅ20ÁÇπ„ÄÅÊ¨°Êó•1ÁÇπ
    - cron: '0 5,12,17 * * *'
  workflow_dispatch:  # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
    inputs:
      skip_test:
        description: 'Ë∑≥ËøáÊµãÈÄüÊ≠•È™§Ôºà‰ªÖÊõ¥Êñ∞Ê∫êÔºâ'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.9'

jobs:
  update-iptv:
    name: Update IPTV Sources
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas
        
    - name: Create template file if not exists
      run: |
        if [ ! -f "demo.txt" ]; then
          echo "Creating default demo.txt template..."
          cat > demo.txt << EOF
        CCTV1
        CCTV2
        CCTV5
        CCTV5+
        CCTV6
        CCTV8
        ÊπñÂçóÂç´ËßÜ
        ÊµôÊ±üÂç´ËßÜ
        Ê±üËãèÂç´ËßÜ
        ‰∏úÊñπÂç´ËßÜ
        Âåó‰∫¨Âç´ËßÜ
        ÂÆâÂæΩÂç´ËßÜ
        EOF
        fi
        
    - name: Run IPTV update script
      env:
        SKIP_TEST: ${{ inputs.skip_test }}
      run: |
        echo "Starting IPTV update process..."
        echo "Current time: $(date)"
        python iptv.py
        
    - name: Update documentation
      run: |
        DATE=$(date '+%Y-%m-%d %H:%M:%S')
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        cat << EOF > README.md
        # üì∫ IPTVÁõ¥Êí≠Ê∫êËá™Âä®Êõ¥Êñ∞‰ªìÂ∫ì
        
        ## üì¢ ÂÖçË¥£Â£∞Êòé
        1. Êú¨‰ªìÂ∫ì‰ªÖ‰æõÂ≠¶‰π†‰ΩøÁî®ÔºåËØ∑Â∞äÈáçÁâàÊùÉÔºåËØ∑ÂãøÂà©Áî®Ê≠§‰ªìÂ∫ì‰ªé‰∫ãÂïÜ‰∏öË°å‰∏∫ÂèäÈùûÊ≥ïÁî®ÈÄî!
        2. ‰ΩøÁî®Êú¨‰ªìÂ∫ìÁöÑËøáÁ®ã‰∏≠ÂèØËÉΩ‰ºö‰∫ßÁîüÁâàÊùÉÊï∞ÊçÆ„ÄÇÂØπ‰∫éËøô‰∫õÁâàÊùÉÊï∞ÊçÆÔºåÊú¨‰ªìÂ∫ì‰∏çÊã•ÊúâÂÆÉ‰ª¨ÁöÑÊâÄÊúâÊùÉ„ÄÇ‰∏∫‰∫ÜÈÅøÂÖç‰æµÊùÉÔºå‰ΩøÁî®ËÄÖÂä°ÂøÖÂú® 24 Â∞èÊó∂ÂÜÖÊ∏ÖÈô§‰ΩøÁî®Êú¨‰ªìÂ∫ìÁöÑËøáÁ®ã‰∏≠ÊâÄ‰∫ßÁîüÁöÑÁâàÊùÉÊï∞ÊçÆ„ÄÇ
        3. Áî±‰∫é‰ΩøÁî®Êú¨‰ªìÂ∫ì‰∫ßÁîüÁöÑÂåÖÊã¨Áî±‰∫éÊú¨ÂçèËÆÆÊàñÁî±‰∫é‰ΩøÁî®ÊàñÊó†Ê≥ï‰ΩøÁî®Êú¨‰ªìÂ∫ìËÄåÂºïËµ∑ÁöÑ‰ªª‰ΩïÊÄßË¥®ÁöÑ‰ªª‰ΩïÁõ¥Êé•„ÄÅÈó¥Êé•„ÄÅÁâπÊÆä„ÄÅÂÅ∂ÁÑ∂ÊàñÁªìÊûúÊÄßÊçüÂÆ≥Áî±‰ΩøÁî®ËÄÖË¥üË¥£„ÄÇ
        4. Á¶ÅÊ≠¢Âú®ËøùÂèçÂΩìÂú∞Ê≥ïÂæãÊ≥ïËßÑÁöÑÊÉÖÂÜµ‰∏ã‰ΩøÁî®Êú¨‰ªìÂ∫ì„ÄÇÂØπ‰∫é‰ΩøÁî®ËÄÖÂú®ÊòéÁü•Êàñ‰∏çÁü•ÂΩìÂú∞Ê≥ïÂæãÊ≥ïËßÑ‰∏çÂÖÅËÆ∏ÁöÑÊÉÖÂÜµ‰∏ã‰ΩøÁî®Êú¨‰ªìÂ∫ìÊâÄÈÄ†ÊàêÁöÑ‰ªª‰ΩïËøùÊ≥ïËøùËßÑË°å‰∏∫Áî±‰ΩøÁî®ËÄÖÊâøÊãÖ„ÄÇ
        5. Â¶ÇÊûúÂÆòÊñπÂπ≥Âè∞ËßâÂæóÊú¨‰ªìÂ∫ì‰∏çÂ¶•ÔºåÂèØËÅîÁ≥ªÊú¨‰ªìÂ∫ìÊõ¥ÊîπÊàñÁßªÈô§„ÄÇ
        
        ## üìä ÊúÄËøëÊõ¥Êñ∞
        **ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥**: $DATE
        
        ## üì• ‰∏ãËΩΩÈìæÊé•
        - [IPTVÊñáÊú¨Ê†ºÂºè (TXT)](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv.txt)
        - [IPTV M3UÊí≠ÊîæÂàóË°®](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv.m3u)
        - [IPTV JSONÊï∞ÊçÆ](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv_data.json)
        - [ÊµãÈÄüÊä•Âëä](https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/speed_report.txt)
        
        ## üõ†Ô∏è ‰ΩøÁî®ËØ¥Êòé
        Â∞Ü‰∏äËø∞ÈìæÊé•Ê∑ªÂä†Âà∞ÊÇ®ÁöÑIPTVÊí≠ÊîæÂô®‰∏≠‰ΩøÁî®Ôºö
        
        ### ÊñáÊú¨Ê†ºÂºè (TXT)
        - ÈÄÇÁî®‰∫éÊîØÊåÅÊñáÊú¨Ê†ºÂºèÁöÑÊí≠ÊîæÂô®
        - Ê†ºÂºèÔºöÈ¢ëÈÅìÂêçÁß∞,URL
        
        ### M3UÊ†ºÂºè
        - ÈÄÇÁî®‰∫éÂ§ßÂ§öÊï∞IPTVÊí≠ÊîæÂô®
        - ÂåÖÂê´È¢ëÈÅìÂàÜÁªÑÂíåÈÄüÂ∫¶‰ø°ÊÅØ
        
        ### Áõ¥Êé•Êí≠ÊîæÈìæÊé•
        ÊÇ®‰πüÂèØ‰ª•Áõ¥Êé•‰ΩøÁî®‰ª•‰∏ãÊ†ºÂºèÁöÑÈìæÊé•Ôºö
        \`\`\`
        https://ghfast.top/https://raw.githubusercontent.com/$REPO_OWNER/$REPO_NAME/main/iptv.m3u
        \`\`\`
        
        ## ‚ö° Ëá™Âä®Êõ¥Êñ∞
        Ê≠§‰ªìÂ∫ìÈÄöËøáGitHub ActionsËá™Âä®Êõ¥Êñ∞Ôºö
        - **Êõ¥Êñ∞Êó∂Èó¥**: ÊØèÂ§©UTCÊó∂Èó¥ 5:00, 12:00, 17:00 (Âåó‰∫¨Êó∂Èó¥ 13:00, 20:00, Ê¨°Êó•1:00)
        - **Êõ¥Êñ∞ÂÜÖÂÆπ**: Ëá™Âä®ÊäìÂèñ„ÄÅÊµãÈÄü„ÄÅÁ≠õÈÄâÊúÄ‰ºòÁõ¥Êí≠Ê∫ê
        - **Ë¥®Èáè‰øùËØÅ**: Âè™‰øùÁïôÈÄüÂ∫¶ > 500KB/s ÁöÑ‰ºòË¥®Ê∫ê
        
        ## üìÅ Êñá‰ª∂ËØ¥Êòé
        - \`iptv.txt\` - ÊñáÊú¨Ê†ºÂºèÁõ¥Êí≠Ê∫êÔºåÊåâÈ¢ëÈÅìÂàÜÁ±ª
        - \`iptv.m3u\` - M3UÊí≠ÊîæÂàóË°®Ê†ºÂºè
        - \`iptv_data.json\` - ÂÆåÊï¥ÁöÑÈ¢ëÈÅìÊï∞ÊçÆÔºàJSONÊ†ºÂºèÔºâ
        - \`speed_report.txt\` - ËØ¶ÁªÜÁöÑÊµãÈÄüÊä•ÂëäÂíåÁªüËÆ°‰ø°ÊÅØ
        - \`process.log\` - Â§ÑÁêÜÊó•Âøó
        - \`demo.txt\` - È¢ëÈÅìÊ®°ÊùøÊñá‰ª∂
        
        ## üîß Êú¨Âú∞ËøêË°å
        Â¶ÇÈúÄÊú¨Âú∞ËøêË°åÊõ¥Êñ∞ËÑöÊú¨Ôºö
        \`\`\`bash
        git clone https://github.com/$REPO_OWNER/$REPO_NAME.git
        cd $REPO_NAME
        pip install requests pandas
        python iptv.py
        \`\`\`
        
        ## ‚≠ê ÊîØÊåÅ
        Â¶ÇÊûúËøô‰∏™È°πÁõÆÂØπÊÇ®ÊúâÂ∏ÆÂä©ÔºåËØ∑Áªô‰∏™StarÔºÅËøôÊòØÂØπÊàë‰ª¨ÊúÄÂ§ßÁöÑÈºìÂä±ÔºÅ
        
        ---
        *Ëá™Âä®Êõ¥Êñ∞‰∫é: $DATE*
        EOF
        
        echo "üìù README.md ÊñáÊ°£Â∑≤Êõ¥Êñ∞"
        
    - name: Check for changes
      id: check_changes
      run: |
        echo "Checking for file changes..."
        git add -A
        if git diff --staged --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "Changes detected in the following files:"
          git diff --staged --name-only
        fi
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        echo "Committing and pushing changes..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git commit -m "üîÑ Auto-update IPTV sources and documentation - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
        
    - name: Upload generated files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: iptv-sources
        path: |
          iptv.txt
          iptv.m3u
          iptv_data.json
          speed_report.txt
          process.log
          README.md
        retention-days: 7
        
    - name: Notify success
      if: success()
      run: |
        echo "üéâ IPTV update completed successfully!"
        echo "üìä Generated files:"
        echo "  - iptv.txt"
        echo "  - iptv.m3u" 
        echo "  - iptv_data.json"
        echo "  - speed_report.txt"
        echo "  - process.log"
        echo "  - README.md"
        
    - name: Notify failure
      if: failure()
      run: |
        echo "‚ùå IPTV update failed!"
        echo "Please check the workflow logs for details."
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: iptv-sources
        path: |
          iptv.txt
          iptv.m3u
        retention-days: 7
