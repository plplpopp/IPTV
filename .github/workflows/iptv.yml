name: Update IPTV

on:
  schedule:
    # æ¯å¤©5ç‚¹ã€12ç‚¹ã€17ç‚¹ï¼ˆUTCæ—¶é—´ï¼‰è¿è¡Œï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´13ç‚¹ã€20ç‚¹ã€æ¬¡æ—¥1ç‚¹
    - cron: '0 5,12,17 * * *'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      skip_test:
        description: 'è·³è¿‡æµ‹é€Ÿæ­¥éª¤ï¼ˆä»…æ›´æ–°æºï¼‰'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.9'
  MAX_RETRY_COUNT: 3
  TIMEOUT_SECONDS: '30'

jobs:
  update-iptv:
    name: Update IPTV Sources
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: Install dependencies
      id: install-deps
      run: |
        echo "å¼€å§‹å®‰è£…Pythonä¾èµ–..."
        python -m pip install --upgrade pip
        pip install requests pandas pyyaml
        echo "ä¾èµ–å®‰è£…å®Œæˆ"
        echo "Pythonç‰ˆæœ¬: $(python --version)"
        echo "Pipç‰ˆæœ¬: $(pip --version)"
        
    - name: Create template file if not exists
      id: create-template
      run: |
        echo "æ£€æŸ¥æ¨¡æ¿æ–‡ä»¶..."
        if [ ! -f "demo.txt" ]; then
          echo "åˆ›å»ºé»˜è®¤ demo.txt æ¨¡æ¿..."
          cat << 'EOF' > demo.txt
          CCTV1
          CCTV2
          CCTV5
          CCTV5+
          CCTV6
          CCTV8
          æ¹–å—å«è§†
          æµ™æ±Ÿå«è§†
          æ±Ÿè‹å«è§†
          ä¸œæ–¹å«è§†
          åŒ—äº¬å«è§†
          å®‰å¾½å«è§†
          EOF
          echo "æ¨¡æ¿æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        else
          echo "demo.txt å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          echo "å½“å‰æ¨¡æ¿å†…å®¹:"
          head -10 demo.txt
        fi
        
    - name: Setup environment variables
      id: setup-env
      run: |
        echo "è®¾ç½®ç¯å¢ƒå˜é‡..."
        # å¤„ç†æ‰‹åŠ¨è§¦å‘å‚æ•°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          if [ "${{ inputs.skip_test }}" = "true" ]; then
            echo "SKIP_SPEED_TEST=true" >> $GITHUB_ENV
            echo "è®¾ç½®ä¸ºè·³è¿‡æµ‹é€Ÿæ¨¡å¼"
          else
            echo "SKIP_SPEED_TEST=false" >> $GITHUB_ENV
            echo "è®¾ç½®ä¸ºå®Œæ•´æµ‹é€Ÿæ¨¡å¼"
          fi
        else
          echo "SKIP_SPEED_TEST=false" >> $GITHUB_ENV
          echo "å®šæ—¶ä»»åŠ¡ï¼Œä½¿ç”¨å®Œæ•´æµ‹é€Ÿæ¨¡å¼"
        fi
        
        echo "ç¯å¢ƒå˜é‡è®¾ç½®å®Œæˆ:"
        echo "SKIP_SPEED_TEST=$SKIP_SPEED_TEST"
        
    - name: Run IPTV update script
      id: run-script
      env:
        SKIP_SPEED_TEST: ${{ env.SKIP_SPEED_TEST }}
        TIMEOUT_SECONDS: ${{ env.TIMEOUT_SECONDS }}
      run: |
        echo "å¼€å§‹ IPTV æ›´æ–°æµç¨‹..."
        echo "å½“å‰æ—¶é—´: $(date)"
        echo "è·³è¿‡æµ‹é€Ÿ: $SKIP_SPEED_TEST"
        echo "è¶…æ—¶è®¾ç½®: $TIMEOUT_SECONDS ç§’"
        
        # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        if [ ! -f "iptv.py" ]; then
          echo "âŒ é”™è¯¯: iptv.py è„šæœ¬ä¸å­˜åœ¨"
          echo "å½“å‰ç›®å½•æ–‡ä»¶:"
          ls -la
          exit 1
        fi
        
        echo "Pythonè„šæœ¬æ£€æŸ¥..."
        python -c "import requests, pandas; print('âœ… ä¾èµ–åº“å¯¼å…¥æˆåŠŸ')"
        
        # æ‰§è¡Œæ›´æ–°è„šæœ¬
        echo "å¼€å§‹æ‰§è¡Œæ›´æ–°è„šæœ¬..."
        start_time=$(date +%s)
        
        if python iptv.py; then
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "âœ… IPTV æ›´æ–°è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          echo "æ‰§è¡Œæ—¶é—´: ${duration} ç§’"
          echo "result=success" >> $GITHUB_OUTPUT
        else
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "âŒ IPTV æ›´æ–°è„šæœ¬æ‰§è¡Œå¤±è´¥"
          echo "æ‰§è¡Œæ—¶é—´: ${duration} ç§’"
          echo "result=failure" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Verify generated files
      id: verify-files
      run: |
        echo "æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶..."
        files=("iptv.txt" "iptv.m3u" "iptv_data.json" "speed_report.txt" "process.log")
        missing_files=()
        
        for file in "${files[@]}"; do
          if [ -f "$file" ]; then
            if [ -s "$file" ]; then
              line_count=$(wc -l < "$file" 2>/dev/null || echo "0")
              file_size=$(wc -c < "$file" 2>/dev/null || echo "0")
              echo "âœ… $file å­˜åœ¨ - $line_count è¡Œ, ${file_size} å­—èŠ‚"
            else
              echo "âš ï¸  $file å­˜åœ¨ä½†ä¸ºç©º"
              missing_files+=("$file(ç©º)")
            fi
          else
            echo "âŒ $file ä¸å­˜åœ¨"
            missing_files+=("$file")
          fi
        done
        
        # å¦‚æœæœ‰æ–‡ä»¶ç¼ºå¤±ï¼Œä½†ä¸é˜»æ­¢æµç¨‹ç»§ç»­
        if [ ${#missing_files[@]} -gt 0 ]; then
          echo "è­¦å‘Š: ä»¥ä¸‹æ–‡ä»¶ç¼ºå¤±æˆ–ä¸ºç©º: ${missing_files[*]}"
          echo "files_missing=true" >> $GITHUB_OUTPUT
        else
          echo "files_missing=false" >> $GITHUB_OUTPUT
        fi
        
        # å…³é”®æ–‡ä»¶æ£€æŸ¥
        if [ ! -f "iptv.txt" ] || [ ! -s "iptv.txt" ]; then
          echo "âŒ å…³é”®æ–‡ä»¶ iptv.txt ç¼ºå¤±æˆ–ä¸ºç©ºï¼Œæµç¨‹å¤±è´¥"
          exit 1
        fi
        
    - name: Generate file statistics
      id: file-stats
      run: |
        echo "ç”Ÿæˆæ–‡ä»¶ç»Ÿè®¡ä¿¡æ¯..."
        
        # è·å–æ–‡ä»¶ç»Ÿè®¡ï¼Œå¤„ç†å¯èƒ½çš„ç©ºæ–‡ä»¶
        TXT_LINES=$(wc -l < iptv.txt 2>/dev/null || echo "0")
        M3U_LINES=$(wc -l < iptv.m3u 2>/dev/null || echo "0")
        JSON_SIZE=$(wc -c < iptv_data.json 2>/dev/null || echo "0")
        SPEED_LINES=$(wc -l < speed_report.txt 2>/dev/null || echo "0")
        
        echo "TXT_LINES=$TXT_LINES" >> $GITHUB_OUTPUT
        echo "M3U_LINES=$M3U_LINES" >> $GITHUB_OUTPUT
        echo "JSON_SIZE=$JSON_SIZE" >> $GITHUB_OUTPUT
        echo "SPEED_LINES=$SPEED_LINES" >> $GITHUB_OUTPUT
        
        echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
        echo "  iptv.txt: $TXT_LINES è¡Œ"
        echo "  iptv.m3u: $M3U_LINES è¡Œ" 
        echo "  iptv_data.json: $JSON_SIZE å­—èŠ‚"
        echo "  speed_report.txt: $SPEED_LINES è¡Œ"
        
    - name: Update documentation
      id: update-docs
      run: |
        echo "æ›´æ–°æ–‡æ¡£..."
        DATE=$(date '+%Y-%m-%d %H:%M:%S')
        REPO_OWNER="${{ github.repository_owner }}"
        REPO_NAME="${{ github.event.repository.name }}"
        
        # ä½¿ç”¨ä¸Šä¸€æ­¥çš„ç»Ÿè®¡ä¿¡æ¯
        TXT_LINES="${{ steps.file-stats.outputs.TXT_LINES }}"
        M3U_LINES="${{ steps.file-stats.outputs.M3U_LINES }}"
        JSON_SIZE="${{ steps.file-stats.outputs.JSON_SIZE }}"
        
        # åˆ›å»ºè¯¦ç»†çš„README
        cat << EOF > README.md
# ğŸ“º IPTVç›´æ’­æºè‡ªåŠ¨æ›´æ–°ä»“åº“

## ğŸ“¢ å…è´£å£°æ˜
1. æœ¬ä»“åº“ä»…ä¾›å­¦ä¹ ä½¿ç”¨ï¼Œè¯·å°Šé‡ç‰ˆæƒï¼Œè¯·å‹¿åˆ©ç”¨æ­¤ä»“åº“ä»äº‹å•†ä¸šè¡Œä¸ºåŠéæ³•ç”¨é€”!
2. ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šäº§ç”Ÿç‰ˆæƒæ•°æ®ã€‚å¯¹äºè¿™äº›ç‰ˆæƒæ•°æ®ï¼Œæœ¬ä»“åº“ä¸æ‹¥æœ‰å®ƒä»¬çš„æ‰€æœ‰æƒã€‚ä¸ºäº†é¿å…ä¾µæƒï¼Œä½¿ç”¨è€…åŠ¡å¿…åœ¨ 24 å°æ—¶å†…æ¸…é™¤ä½¿ç”¨æœ¬ä»“åº“çš„è¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„ç‰ˆæƒæ•°æ®ã€‚
3. ç”±äºä½¿ç”¨æœ¬ä»“åº“äº§ç”Ÿçš„åŒ…æ‹¬ç”±äºæœ¬åè®®æˆ–ç”±äºä½¿ç”¨æˆ–æ— æ³•ä½¿ç”¨æœ¬ä»“åº“è€Œå¼•èµ·çš„ä»»ä½•æ€§è´¨çš„ä»»ä½•ç›´æ¥ã€é—´æ¥ã€ç‰¹æ®Šã€å¶ç„¶æˆ–ç»“æœæ€§æŸå®³ç”±ä½¿ç”¨è€…è´Ÿè´£ã€‚
4. ç¦æ­¢åœ¨è¿åå½“åœ°æ³•å¾‹æ³•è§„çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“ã€‚å¯¹äºä½¿ç”¨è€…åœ¨æ˜çŸ¥æˆ–ä¸çŸ¥å½“åœ°æ³•å¾‹æ³•è§„ä¸å…è®¸çš„æƒ…å†µä¸‹ä½¿ç”¨æœ¬ä»“åº“æ‰€é€ æˆçš„ä»»ä½•è¿æ³•è¿è§„è¡Œä¸ºç”±ä½¿ç”¨è€…æ‰¿æ‹…ã€‚
5. å¦‚æœå®˜æ–¹å¹³å°è§‰å¾—æœ¬ä»“åº“ä¸å¦¥ï¼Œå¯è”ç³»æœ¬ä»“åº“æ›´æ”¹æˆ–ç§»é™¤ã€‚

## ğŸ“Š æœ€è¿‘æ›´æ–°
**æœ€åæ›´æ–°æ—¶é—´**: $DATE  
**é¢‘é“æ•°é‡**: $TXT_LINES ä¸ªé¢‘é“  
**æ’­æ”¾åˆ—è¡¨å¤§å°**: $M3U_LINES è¡Œ  
**æ•°æ®æ–‡ä»¶**: $JSON_SIZE å­—èŠ‚  
**æ›´æ–°æ–¹å¼**: ${{ github.event_name == 'workflow_dispatch' && 'æ‰‹åŠ¨è§¦å‘' || 'è‡ªåŠ¨å®šæ—¶' }}

## ğŸ“¥ ä¸‹è½½é“¾æ¥
- [IPTVæ–‡æœ¬æ ¼å¼ (TXT)](./iptv.txt) - $TXT_LINES ä¸ªé¢‘é“
- [IPTV M3Uæ’­æ”¾åˆ—è¡¨](./iptv.m3u) - $M3U_LINES è¡Œ
- [IPTV JSONæ•°æ®](./iptv_data.json) - $JSON_SIZE å­—èŠ‚
- [æµ‹é€ŸæŠ¥å‘Š](./speed_report.txt)

## ğŸ› ï¸ ä½¿ç”¨è¯´æ˜
å°†ä¸Šè¿°é“¾æ¥æ·»åŠ åˆ°æ‚¨çš„IPTVæ’­æ”¾å™¨ä¸­ä½¿ç”¨ï¼š

### æ–‡æœ¬æ ¼å¼ (TXT)
- é€‚ç”¨äºæ”¯æŒæ–‡æœ¬æ ¼å¼çš„æ’­æ”¾å™¨
- æ ¼å¼ï¼šé¢‘é“åç§°,URL

### M3Uæ ¼å¼
- é€‚ç”¨äºå¤§å¤šæ•°IPTVæ’­æ”¾å™¨
- åŒ…å«é¢‘é“åˆ†ç»„å’Œé€Ÿåº¦ä¿¡æ¯

## âš¡ è‡ªåŠ¨æ›´æ–°
æ­¤ä»“åº“é€šè¿‡GitHub Actionsè‡ªåŠ¨æ›´æ–°ï¼š
- **æ›´æ–°æ—¶é—´**: æ¯å¤©UTCæ—¶é—´ 5:00, 12:00, 17:00 (åŒ—äº¬æ—¶é—´ 13:00, 20:00, æ¬¡æ—¥1:00)
- **æ›´æ–°å†…å®¹**: è‡ªåŠ¨æŠ“å–ã€æµ‹é€Ÿã€ç­›é€‰æœ€ä¼˜ç›´æ’­æº
- **è´¨é‡ä¿è¯**: åªä¿ç•™é€Ÿåº¦ > 500KB/s çš„ä¼˜è´¨æº

## ğŸ“ æ–‡ä»¶è¯´æ˜
- \`iptv.txt\` - æ–‡æœ¬æ ¼å¼ç›´æ’­æºï¼ŒæŒ‰é¢‘é“åˆ†ç±» ($TXT_LINES ä¸ªé¢‘é“)
- \`iptv.m3u\` - M3Uæ’­æ”¾åˆ—è¡¨æ ¼å¼ ($M3U_LINES è¡Œ)
- \`iptv_data.json\` - å®Œæ•´çš„é¢‘é“æ•°æ®ï¼ˆJSONæ ¼å¼, $JSON_SIZE å­—èŠ‚ï¼‰
- \`speed_report.txt\` - è¯¦ç»†çš„æµ‹é€ŸæŠ¥å‘Šå’Œç»Ÿè®¡ä¿¡æ¯
- \`process.log\` - å¤„ç†æ—¥å¿—
- \`demo.txt\` - é¢‘é“æ¨¡æ¿æ–‡ä»¶

## ğŸ”§ æœ¬åœ°è¿è¡Œ
å¦‚éœ€æœ¬åœ°è¿è¡Œæ›´æ–°è„šæœ¬ï¼š
\`\`\`bash
git clone https://github.com/$REPO_OWNER/$REPO_NAME.git
cd $REPO_NAME
pip install requests pandas
python iptv.py
\`\`\`

## â­ æ”¯æŒ
å¦‚æœè¿™ä¸ªé¡¹ç›®å¯¹æ‚¨æœ‰å¸®åŠ©ï¼Œè¯·ç»™ä¸ªStarï¼è¿™æ˜¯å¯¹æˆ‘ä»¬æœ€å¤§çš„é¼“åŠ±ï¼

---
*è‡ªåŠ¨æ›´æ–°äº: $DATE*  
*å·¥ä½œæµè¿è¡Œ: [#${{ github.run_number }}](https://github.com/$REPO_OWNER/$REPO_NAME/actions/runs/${{ github.run_id }})*
EOF
        
        echo "ğŸ“ README.md æ–‡æ¡£å·²æ›´æ–°"
        
    - name: Check for changes
      id: check_changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        git add -A
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        if git diff --staged --quiet; then
          echo "changes=false" >> $GITHUB_OUTPUT
          echo "âœ… æœªæ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
        else
          echo "changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´:"
          git diff --staged --name-only
          echo "å˜æ›´è¯¦æƒ…:"
          git diff --staged --stat
        fi
        
    - name: Pull latest changes before push
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        echo "ğŸ”„ æ¨é€å‰æ‹‰å–æœ€æ–°æ›´æ”¹..."
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git pull origin main --rebase --allow-unrelated-histories || echo "æ‹‰å–å¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ"
        echo "æ‹‰å–å®Œæˆ"
        
    - name: Commit and push changes
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        echo "ğŸ“¤ æäº¤å¹¶æ¨é€æ›´æ”¹..."
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        COMMIT_MSG="ğŸ”„ Auto-update IPTV sources - $(date +'%Y-%m-%d %H:%M:%S')
        
        è‡ªåŠ¨æ›´æ–°ç›´æ’­æºæ–‡ä»¶
        - é¢‘é“æ•°é‡: ${{ steps.file-stats.outputs.TXT_LINES }}
        - æ’­æ”¾åˆ—è¡¨: ${{ steps.file-stats.outputs.M3U_LINES }} è¡Œ
        - æ•°æ®æ–‡ä»¶: ${{ steps.file-stats.outputs.JSON_SIZE }} å­—èŠ‚
        - æµ‹é€ŸæŠ¥å‘Š: ${{ steps.file-stats.outputs.SPEED_LINES }} è¡Œ
        
        å·¥ä½œæµè¿è¡Œ: #${{ github.run_number }}"
        
        git commit -m "$COMMIT_MSG"
        
        # é‡è¯•æ¨é€æœºåˆ¶
        for i in $(seq 1 ${{ env.MAX_RETRY_COUNT }}); do
          echo "å°è¯•æ¨é€ (ç¬¬ $i æ¬¡)..."
          if git push origin main; then
            echo "âœ… æ¨é€æˆåŠŸ"
            break
          else
            if [ $i -eq ${{ env.MAX_RETRY_COUNT }} ]; then
              echo "âŒ æ¨é€å¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            else
              echo "âš ï¸  æ¨é€å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
              sleep 10
              git pull origin main --rebase --allow-unrelated-histories
            fi
          fi
        done
        
    - name: Upload generated files as artifact
      uses: actions/upload-artifact@v4
      with:
        name: iptv-sources-${{ github.run_number }}
        path: |
          iptv.txt
          iptv.m3u
          iptv_data.json
          speed_report.txt
          process.log
          README.md
        retention-days: 7
        if-no-files-found: warn
        
    - name: Success notification
      if: success()
      run: |
        echo "ğŸ‰ IPTV æ›´æ–°å®Œæˆï¼"
        echo "ğŸ“Š æœ€ç»ˆæ–‡ä»¶ç»Ÿè®¡:"
        echo "   - iptv.txt: ${{ steps.file-stats.outputs.TXT_LINES }} è¡Œ"
        echo "   - iptv.m3u: ${{ steps.file-stats.outputs.M3U_LINES }} è¡Œ"
        echo "   - iptv_data.json: ${{ steps.file-stats.outputs.JSON_SIZE }} å­—èŠ‚"
        echo "   - speed_report.txt: ${{ steps.file-stats.outputs.SPEED_LINES }} è¡Œ"
        echo "ğŸ“ å˜æ›´çŠ¶æ€: ${{ steps.check_changes.outputs.changes == 'true' && 'å·²æäº¤' || 'æ— å˜æ›´' }}"
        echo "âœ… æ‰€æœ‰æ­¥éª¤å®Œæˆ - è¿è¡Œç¼–å·: #${{ github.run_number }}"
        
    - name: Failure notification
      if: failure()
      run: |
        echo "âŒ IPTV æ›´æ–°å¤±è´¥ï¼"
        echo "å¤±è´¥æ—¶é—´: $(date)"
        echo "è¿è¡Œç¼–å·: #${{ github.run_number }}"
        echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
        echo "å¤±è´¥æ­¥éª¤: ${{ steps.*.outcome }}"
        exit 1
